var U=Object.defineProperty;var H=(r,e,t)=>e in r?U(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>H(r,typeof e!="symbol"?e+"":e,t);import{a as c,q as z,A as w,x as B,B as J,z as V,C as K,p as m,O as Y}from"./chunk-UIGDSWPH-CtiJzZl8.js";import{g as N,O as Z}from"./Options-DIhddWk5.js";import{i as X}from"./gameID-tORuqkkw.js";import{t as b}from"./ToastProvider-DOBgYgXK.js";/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=r=>r.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase(),ee=r=>r.replace(/^([A-Z])|[\s-_]+(\w)/g,(e,t,o)=>o?o.toUpperCase():t.toLowerCase()),D=r=>{const e=ee(r);return e.charAt(0).toUpperCase()+e.slice(1)},A=(...r)=>r.filter((e,t,o)=>!!e&&e.trim()!==""&&o.indexOf(e)===t).join(" ").trim(),te=r=>{for(const e in r)if(e.startsWith("aria-")||e==="role"||e==="title")return!0};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var ne={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=c.forwardRef(({color:r="currentColor",size:e=24,strokeWidth:t=2,absoluteStrokeWidth:o,className:s="",children:a,iconNode:n,...i},d)=>c.createElement("svg",{ref:d,...ne,width:e,height:e,stroke:r,strokeWidth:o?Number(t)*24/Number(e):t,className:A("lucide",s),...!a&&!te(i)&&{"aria-hidden":"true"},...i},[...n.map(([h,_])=>c.createElement(h,_)),...Array.isArray(a)?a:[a]]));/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=(r,e)=>{const t=c.forwardRef(({className:o,...s},a)=>c.createElement(re,{ref:a,iconNode:e,className:A(`lucide-${Q(D(r))}`,`lucide-${r}`,o),...s}));return t.displayName=D(r),t};/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]],se=G("house",oe);/**
 * @license lucide-react v0.548.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],ae=G("settings",ie),ce="wss://turn-tracker-backend.fly.dev/ws",le=2e3,P=5,ue=100,v=1e4;class de{constructor(){l(this,"ws",null);l(this,"reconnectAttempts",0);l(this,"reconnectTimer",null);l(this,"messageCallbacks",new Set);l(this,"isDestroyed",!1);l(this,"connectPromise",null);l(this,"clientID");l(this,"isPersistent",!1)}setClientID(e){this.clientID=e}setPersistent(e){this.isPersistent=e,e&&(this.reconnectAttempts=0)}async connect(){var e;return this.connectPromise?this.connectPromise:((e=this.ws)==null?void 0:e.readyState)===WebSocket.OPEN?Promise.resolve():(this.connectPromise=new Promise((t,o)=>{var s;if(((s=this.ws)==null?void 0:s.readyState)===WebSocket.CONNECTING){const a=()=>{var n,i;((n=this.ws)==null?void 0:n.readyState)===WebSocket.OPEN?(this.connectPromise=null,t()):((i=this.ws)==null?void 0:i.readyState)===WebSocket.CLOSED?(this.connectPromise=null,o(new Error("Connection closed"))):setTimeout(a,ue)};a();return}try{let a=ce;this.clientID&&(a+=`?client_id=${encodeURIComponent(this.clientID)}`),this.ws=new WebSocket(a),this.ws.onopen=()=>{console.log("WebSocket connected"),this.reconnectAttempts=0,this.connectPromise=null,t()},this.ws.onmessage=n=>{try{const i=JSON.parse(n.data);this.messageCallbacks.forEach(d=>d(i))}catch(i){console.error("Error parsing message:",i)}},this.ws.onerror=n=>{console.error("WebSocket error:",n),this.connectPromise=null,o(n)},this.ws.onclose=()=>{console.log("WebSocket closed"),this.connectPromise=null,this.isDestroyed||this.attemptReconnect()}}catch(a){this.connectPromise=null,o(a)}}),this.connectPromise)}async send(e,t){return await this.connect(),new Promise((o,s)=>{if(!this.ws||this.ws.readyState!==WebSocket.OPEN){s(new Error("WebSocket not connected"));return}const a={type:e,data:t};try{this.ws.send(JSON.stringify(a)),o()}catch(n){s(n)}})}waitForMessage(e,t){return new Promise((o,s)=>{const a=d=>{var h;if(d.type===e){if(t&&!t(d.data))return;n(),clearTimeout(i),o(d)}else d.type==="error"&&(n(),clearTimeout(i),s(new Error(((h=d.data)==null?void 0:h.message)||"Server error")))},n=this.onMessage(a),i=setTimeout(()=>{n(),s(new Error(`${e} timeout after ${v}ms`))},v)})}async sendAndWait(e,t){const o=this.waitForMessage(t.type,t.validator);return await this.send(e.type,e.data),o}onMessage(e){return this.messageCallbacks.add(e),()=>{this.messageCallbacks.delete(e)}}attemptReconnect(){if(!this.isPersistent&&this.reconnectAttempts>=P){console.error("Max reconnect attempts reached");return}this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectAttempts++;const e=this.isPersistent?`${this.reconnectAttempts} (persistent)`:`${this.reconnectAttempts}/${P}`;console.log(`Attempting to reconnect (${e})...`),this.reconnectTimer=setTimeout(()=>{this.connect().catch(t=>{console.error("Reconnect failed:",t)})},le)}destroy(){this.isDestroyed=!0,this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.messageCallbacks.clear(),this.connectPromise=null}}const j="turnTracker_clientID";function W(){return localStorage}function me(){if(typeof window>"u")return null;try{return W().getItem(j)}catch(r){return console.warn("Persist: Failed to read clientID from storage:",r),null}}function E(r){if(!(typeof window>"u"))try{W().setItem(j,r)}catch(e){console.warn("Persist: Failed to save clientID to storage:",e)}}class he{constructor(){l(this,"_connection");l(this,"_gameID");l(this,"_clientID");l(this,"_displayName");l(this,"_color");l(this,"_peers",[]);l(this,"_currentTurn",null);l(this,"_turnStartTime",null);l(this,"_lastTurnSequence",0);l(this,"peerCallbacks",new Set);l(this,"turnCallbacks",new Set);this._connection=new de,this._connection.setPersistent(!0),this.setupMessageHandlers()}get connection(){return this._connection}get gameID(){return this._gameID}get displayName(){return this._displayName}get color(){return this._color}get clientID(){return this._clientID}setClientID(e){this._clientID=e,this._connection.setClientID(e)}get peers(){return[...this._peers]}get currentTurn(){return this._currentTurn}get turnStartTime(){return this._turnStartTime}set gameID(e){this._gameID=e.toUpperCase()}updatePeers(e){this._peers=e,this.peerCallbacks.forEach(t=>t(this._peers))}updateCurrentTurn(e,t=null){this._currentTurn=e,this._turnStartTime=t,this.turnCallbacks.forEach(o=>o(this._currentTurn,this._turnStartTime))}onPeersChange(e){return console.log("onPeersChange",this._peers),this.peerCallbacks.add(e),e(this._peers),()=>{this.peerCallbacks.delete(e)}}onTurnChange(e){return this.turnCallbacks.add(e),e(this._currentTurn,this._turnStartTime),()=>{this.turnCallbacks.delete(e)}}setupMessageHandlers(){this._connection.onMessage(e=>{var t,o,s,a;switch(e.type){case"room_created":if((t=e.data)!=null&&t.room_id){this.gameID=e.data.room_id;const n=e.data,i=n.peers||[],d=n.current_turn||null;if(this._lastTurnSequence=0,n.your_client_id){this._clientID=n.your_client_id;const h=i.find(_=>_.client_id===n.your_client_id);h&&(this._displayName=h.display_name,this._color=h.color),E(this._clientID)}this.updatePeers(i),this.updateCurrentTurn(d,null)}break;case"room_joined":if((o=e.data)!=null&&o.room_id){this.gameID=e.data.room_id;const n=e.data,i=n.peers||[],d=n.current_turn||null;this._lastTurnSequence=0,n.your_client_id&&(this._clientID=n.your_client_id,E(this._clientID)),this.updatePeers(i),this.updateCurrentTurn(d,null)}break;case"player_joined":{const n=e.data,i={client_id:n.peer_id,display_name:n.display_name,color:n.color,total_turn_time:0};this.updatePeers([...this._peers,i]);break}case"player_left":{const n=e.data;this.updatePeers(this._peers.filter(i=>i.client_id!==n.peer_id)),((s=this._currentTurn)==null?void 0:s.client_id)===n.peer_id&&this.updateCurrentTurn(null,null);break}case"profile_updated":{const n=e.data;n.peer_id===this._clientID&&(this._displayName=n.display_name,this._color=n.color),this.updatePeers(this._peers.map(i=>i.client_id===n.peer_id?{client_id:n.peer_id,display_name:n.display_name,color:n.color,total_turn_time:n.total_turn_time??i.total_turn_time}:i));break}case"turn_changed":{const n=e.data;if(n.sequence&&n.sequence<=this._lastTurnSequence){console.log(`Ignoring stale turn_changed message: sequence ${n.sequence} <= ${this._lastTurnSequence}`);break}n.sequence&&(this._lastTurnSequence=n.sequence),this.updateCurrentTurn(n.current_turn,n.turn_start_time??null);break}case"error":{const n=((a=e.data)==null?void 0:a.message)||"An error occurred";console.error("Server error:",n),window.dispatchEvent(new CustomEvent("toast",{detail:{type:"error",message:n}}));break}}})}onMessage(e){return this._connection.onMessage(e)}destroy(){console.log("Destroying WebSocketManager"),this._connection.destroy(),this._gameID=void 0,this._peers=[],this._currentTurn=null,this.peerCallbacks.clear(),this.turnCallbacks.clear()}}let p=null;function ge(){if(!p){console.log("getPersistentConnection: Creating new WebSocketManager"),p=new he;const r=me();r&&p.setClientID(r)}return p}function pe(){p&&(p.destroy(),p=null)}async function _e(r){console.log("Creating game (backend will generate ID)");const e=N(),t={};return e.displayName&&(t.display_name=e.displayName),e.color&&(t.color=e.color),r.connection.sendAndWait({type:"create_room",data:t},{type:"room_created",validator:o=>!!(o!=null&&o.room_id)})}async function fe(r,e){if(console.log("Joining game:",e),!X(e))throw new Error("Invalid game ID");const t=e.toUpperCase(),o=N(),s={room_id:t};return o.displayName&&(s.display_name=o.displayName),o.color&&(s.color=o.color),r.connection.sendAndWait({type:"join_room",data:s},{type:"room_joined",validator:a=>(a==null?void 0:a.room_id)===t})}async function Te({params:r}){var o;console.log("GameContainer: Starting ClientLoader");const e=ge(),t=!!(r.gameID&&r.gameID.trim().length>0);if(!t){console.log("GameContainer: Creating new game");try{await _e(e)}catch(s){console.error("GameContainer: Error creating game:",s),x(s,"create")}if(e.gameID)throw console.log("GameContainer: Redirecting to game",e.gameID),w(`/game/${e.gameID}`)}if(t&&e.gameID!==((o=r.gameID)==null?void 0:o.toUpperCase())){console.log("GameContainer: Joining game",r.gameID);try{await fe(e,r.gameID)}catch(s){console.error("GameContainer: Error joining game:",s),x(s,"join",r.gameID)}console.log("GameContainer: Game joined successfully, gameID:",e.gameID)}return e}function x(r,e,t){console.error(`GameContainer: Error ${e==="create"?"creating":"joining"} game:`,r);const o=r instanceof Error?r.message:e==="create"?"Failed to create game":"Failed to join game";throw b.error(o),e==="join"&&t?w(`/?code=${t}`):w("/")}const Ie=z(function(){const e=B(),t=J(),o=V(),s=t==null?void 0:t.gameID,[a,n]=c.useState((t==null?void 0:t.peers)||[]),[i,d]=c.useState((t==null?void 0:t.currentTurn)||null),[h,_]=c.useState((t==null?void 0:t.turnStartTime)||null),[L,k]=c.useState(!1),C=c.useRef(null),y=c.useRef(t),M=c.useRef(e.pathname),O=c.useRef(s);c.useEffect(()=>{M.current=e.pathname,O.current=s},[e.pathname,s]);const R=()=>{t&&t.gameID&&t.connection.send("leave_room",{room_id:t.gameID}).catch(u=>console.error("GameContainer: Error sending leave_room:",u)),pe(),o("/")},$=async()=>{if(s)try{await navigator.clipboard.writeText(s),b.success("Game code copied!")}catch(u){console.error("GameContainer: Failed to copy game code:",u),b.error("Failed to copy game code")}},q=()=>{k(!0)},T=()=>{k(!1)},I=c.useCallback(u=>{n(u)},[]),S=c.useCallback((u,g)=>{d(u),_(g)},[]);c.useEffect(()=>{if(!s)return;if(!i){if(e.pathname.includes("/turn/")){const g=`/game/${s}`;e.pathname!==g&&o(g)}return}const u=`/game/${s}/turn/${i.client_id}/`;e.pathname!==u&&o(u)},[i,s,o,e.pathname]),c.useEffect(()=>{if(console.log("GameContainer: Subscribing to WebSocket events"),!t)return;const u=t.onPeersChange(I),g=t.onTurnChange(S);return()=>{u(),g()}},[t,I,S]),c.useEffect(()=>{y.current=t},[t]),K(()=>{y.current&&(console.log("GameContainer: Cleaning up WebSocket connection on page unload"),y.current.destroy())}),c.useEffect(()=>{console.log("GameContainer: Requesting wake lock");const u=async()=>{if("wakeLock"in navigator)try{const f=await navigator.wakeLock.request("screen");C.current=f}catch(f){console.error("GameContainer: Failed to acquire wake lock:",f)}};u();const g=()=>{document.visibilityState==="visible"&&C.current===null&&u()};return document.addEventListener("visibilitychange",g),()=>{document.removeEventListener("visibilitychange",g),C.current&&C.current.release().catch(f=>{console.error("GameContainer: Failed to release wake lock:",f)})}},[]);const F=c.useMemo(()=>({ws:t,peers:a,currentTurn:i,turnStartTime:h}),[t,a,i,h]);return m.jsxs("div",{className:"h-screen overflow-hidden",children:[m.jsx("div",{className:"h-[calc(100vh-52px)] overflow-hidden pt-6",children:m.jsx(Y,{context:F})}),m.jsxs("div",{className:"fixed bottom-0 left-0 w-full bg-[#0D111A]/90 backdrop-blur-md border-t border-gray-700 flex items-center justify-between px-3 py-3 z-50",children:[m.jsx("div",{className:"flex items-center gap-5",children:m.jsx("button",{onClick:R,className:"text-gray-300 hover:text-white transition-transform hover:scale-110 active:scale-95","aria-label":"Home",children:m.jsx(se,{size:26})})}),m.jsx("div",{className:"text-white font-semibold tracking-widest text-lg select-none cursor-pointer",onClick:$,title:"Click to copy",children:s}),m.jsx("button",{onClick:q,className:"text-gray-300 hover:text-white transition-transform hover:scale-110 active:scale-95","aria-label":"Settings",children:m.jsx(ae,{size:26})})]}),L&&m.jsx("div",{"data-testid":"options-modal-backdrop",className:"fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50",onClick:T,children:m.jsx("div",{className:"bg-[#0D111A] border border-gray-700 rounded-lg p-8 max-w-md w-full mx-4",onClick:u=>u.stopPropagation(),children:m.jsx(Z,{onClose:T,ws:t||void 0})})})]})});export{Te as clientLoader,Ie as default};
